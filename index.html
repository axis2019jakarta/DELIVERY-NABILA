<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Platform Nabila Logistik (Supabase Backend)</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <!-- Supabase Client Library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        :root {
            --primary-color: #FF69B4; --secondary-color: #4A90E2; --dark-color: #333;
            --light-color: #f4f4f4; --white-color: #fff; --success-color: #28a745;
            --danger-color: #dc3545; --warning-color: #ffc107; --font-family: 'Poppins', sans-serif;
        }
        body { font-family: var(--font-family); background-color: #e9ebee; color: var(--dark-color); line-height: 1.6; }
        .container { max-width: 1400px; margin: 20px auto; padding: 0 20px; }
        .platform-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 25px; }
        .platform-module { background: var(--white-color); border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); padding: 25px; }
        .platform-module h2 { font-size: 1.5rem; border-bottom: 2px solid var(--light-color); padding-bottom: 10px; margin-bottom: 20px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 600; }
        .form-group input, .form-group select { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 5px; }
        .btn { padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; font-weight: 600; transition: all 0.2s ease; text-align: center; width: 100%; font-size: 1rem; }
        .btn:disabled { background-color: #ccc; cursor: not-allowed; }
        .btn-primary { background: var(--primary-color); color: white; } .btn-primary:hover:not(:disabled) { background: #e0559d; }
        .btn-secondary { background: var(--secondary-color); color: white; } .btn-secondary:hover:not(:disabled) { background: #3a7cc4; }
        .btn-success { background: var(--success-color); color: white; }
        .btn-sm { padding: 5px 10px; font-size: 0.8rem; }
        .order-card, .driver-card { border: 1px solid #eee; border-radius: 8px; padding: 15px; margin-bottom: 15px; }
        .status { font-weight: bold; padding: 3px 8px; border-radius: 5px; color: white; font-size: 0.8rem; display: inline-block; }
        .status-searching_driver { background: var(--warning-color); }
        .status-assigned { background: var(--secondary-color); }
        .status-pickup { background: #fd7e14; }
        .status-delivering { background: #0dcaf0; }
        .status-completed { background: var(--success-color); }
        .status-pending { background: var(--danger-color); }
        .status-active { background: var(--success-color); }
        #map { height: 350px; width: 100%; border-radius: 8px; margin-top: 20px; background-color: #eee; }
        .loading { text-align: center; padding: 20px; font-style: italic; color: #888; }
        #config-alert { background: #fff3cd; color: #664d03; border: 1px solid #ffc107; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        @media (max-width: 1200px) { .platform-grid { grid-template-columns: 1fr 1fr; } }
        @media (max-width: 768px) { .platform-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

    <div class="container">
        <div style="text-align: center; margin-bottom: 25px;">
            <h1>Nabila Logistik - Platform Management (Live Backend)</h1>
        </div>

        <div id="config-alert">
            <strong>PENTING:</strong> Pastikan Anda telah memasukkan URL Supabase, Kunci Anon, dan Kunci API OpenRouteService di dalam tag <script> di bawah.
        </div>

        <div class="platform-grid">
            <!-- MODULE 1: PELANGGAN (Simulasi sebagai user 'pelanggan@email.com') -->
            <div class="platform-module">
                <h2>üë§ Panel Pelanggan</h2>
                <div id="customer-profile" class="loading">Memuat profil...</div>
                <hr style="margin: 20px 0;">
                <h4>Buat Pesanan Baru</h4>
                <div class="form-group">
                    <label for="pickup">Lokasi Jemput</label>
                    <input type="text" id="pickup" placeholder="Ketik alamat jemput">
                </div>
                <div class="form-group">
                    <label for="dropoff">Lokasi Antar</label>
                    <input type="text" id="dropoff" placeholder="Ketik alamat antar">
                </div>
                <button id="calculate-btn" class="btn btn-secondary">Hitung Biaya</button>
                <div id="price-display" style="display: none; margin-top: 15px; text-align: center;">
                    <p>Estimasi Jarak: <strong id="distance">0 km</strong></p>
                    <h3>Biaya: <strong id="price">Rp 0</strong></h3>
                </div>
                <button id="order-btn" class="btn btn-primary" style="margin-top: 15px;" disabled>Order Sekarang</button>
            </div>

            <!-- MODULE 2: ADMIN (Simulasi sebagai user 'admin@email.com') -->
            <div class="platform-module">
                <h2>üëë Dashboard Admin</h2>
                <h4>Driver Terdaftar</h4>
                <div id="admin-driver-list" class="loading">Memuat driver...</div>
                <hr style="margin: 20px 0;">
                <h4>Order Masuk (Realtime)</h4>
                <div id="admin-order-list" class="loading">Menunggu order...</div>
            </div>

            <!-- MODULE 3: DRIVER (Pilih driver untuk melihat panelnya) -->
            <div class="platform-module">
                <h2>üèçÔ∏è Panel Driver</h2>
                <div class="form-group">
                    <label for="driver-selector">Pilih Akun Driver</label>
                    <select id="driver-selector" onchange="renderDriverPanel(this.value)"></select>
                </div>
                <div id="driver-profile-view"></div>
                <hr style="margin: 20px 0;">
                <h4>Tugas Untuk Anda (Realtime)</h4>
                <div id="driver-task-list"></div>
            </div>
        </div>
        
        <div class="platform-module" style="margin-top:25px;">
            <h2>üó∫Ô∏è Peta Pelacakan</h2>
            <div id="map"></div>
        </div>
    </div>

    <script>
    // ===================================================================================
    // BAGIAN 1: KONFIGURASI & KONEKSI SUPABASE
    // INI ADALAH BAGIAN PALING PENTING. JANGAN LEWATKAN!
    // ===================================================================================

    // ‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº MASUKKAN KUNCI API ANDA DI SINI ‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº
    const SUPABASE_URL = 'https://lvbcwilldsfxkweqfpyz.supabase.co'; 
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx2YmN3aWxsZHNmeGt3ZXFmcHl6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE3MzE2NjgsImV4cCI6MjA2NzMwNzY2OH0.-O_ddTcVKkS3xJDi5wQRoHIlpE5d3uAraXGXaZ62v98'; 
    const ORS_API_KEY = 'eyJvcmciOiI1YjNjZTM1OTc4NTExMTAwMDFjZjYyNDgiLCJpZCI6IjA1MGZhMjk5OTc1NjQxYzViMmYxMTI4OTMzZjc3NWE4IiwiaCI6Im11cm11cjY0In0=';
    // ‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤

    const JABODETABEK_CENTER = [-6.2088, 106.8456];
    
    // Inisialisasi Klien Supabase
    let supabase;
    if (SUPABASE_URL.includes('URL_PROYEK') || SUPABASE_ANON_KEY.includes('KUNCI_ANON')) {
        document.getElementById('config-alert').innerHTML = '<strong>KESALAHAN:</strong> Anda belum memasukkan URL dan Kunci Anon Supabase. Harap edit file ini.';
    } else {
        document.getElementById('config-alert').style.display = 'none';
        supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    }
    
    // ===================================================================================
    // BAGIAN 2: STATE MANAGEMENT & DATA LOKAL
    // ===================================================================================
    let localState = {
        orders: [],
        drivers: [],
        customerProfile: null,
        // Untuk simulasi login, kita tentukan UUID user secara manual.
        // Di aplikasi nyata, ini didapat dari `supabase.auth.getUser()`
        // Anda bisa mendapatkan UUID ini dari tabel `auth.users` di Supabase setelah mendaftar.
        SIMULATED_CUSTOMER_ID: 'UUID_USER_PELANGGAN_ANDA', // Ganti dengan UUID user pelanggan
    };

    let calculatedRoute = null; // Menyimpan hasil perhitungan rute terakhir
    let map, mapMarkers = {}, mapRoutes = {};


    // ===================================================================================
    // BAGIAN 3: FUNGSI UTAMA (FETCH, RENDER, REALTIME)
    // ===================================================================================
    
    /**
     * Mengambil semua data awal dari Supabase
     */
    async function initializeApp() {
        if (!supabase) return;

        await Promise.all([
            fetchCustomerProfile(),
            fetchDrivers(),
            fetchOrders()
        ]);
        
        renderAll();
        listenToChanges();
    }
    
    async function fetchCustomerProfile() {
        const { data, error } = await supabase.from('profiles').select('*').eq('id', localState.SIMULATED_CUSTOMER_ID).single();
        if (error) console.error('Error fetching customer profile:', error);
        else localState.customerProfile = data;
    }

    async function fetchDrivers() {
        const { data, error } = await supabase.from('profiles').select('*').eq('role', 'driver');
        if (error) console.error('Error fetching drivers:', error);
        else localState.drivers = data;
    }

    async function fetchOrders() {
        const { data, error } = await supabase.from('orders').select('*, customer:profiles!customer_id(*), driver:profiles!driver_id(*)').order('created_at', { ascending: false });
        if (error) console.error('Error fetching orders:', error);
        else localState.orders = data;
    }

    /**
     * Merender semua komponen di halaman
     */
    function renderAll() {
        renderCustomerPanel();
        renderAdminPanel();
        renderDriverSelector();
        if(localState.drivers.length > 0) {
            renderDriverPanel(localState.drivers[0].id);
        }
    }
    
    function renderCustomerPanel() {
        const el = document.getElementById('customer-profile');
        if (!localState.customerProfile) {
            el.innerHTML = 'Gagal memuat profil. Pastikan UUID Pelanggan benar.';
            return;
        }
        el.className = 'driver-card';
        el.innerHTML = `
            <h4>${localState.customerProfile.full_name}</h4>
            <div style="font-size: 1.1rem; font-weight: 600; color: var(--success-color);">
                Saldo: Rp ${localState.customerProfile.balance.toLocaleString('id-ID')}
            </div>
        `;
    }

    function renderAdminPanel() {
        const driverListEl = document.getElementById('admin-driver-list');
        driverListEl.innerHTML = '';
        if (localState.drivers.length === 0) {
            driverListEl.innerHTML = '<div class="loading">Belum ada driver terdaftar.</div>';
        } else {
            localState.drivers.forEach(driver => {
                const card = document.createElement('div');
                card.className = 'driver-card';
                card.innerHTML = `
                    <h4>${driver.full_name}</h4>
                    <div>Status: <span class="status status-${driver.status}">${driver.status}</span></div>
                    <div style="color: var(--success-color);">Saldo: Rp ${driver.balance.toLocaleString('id-ID')}</div>
                    ${driver.status === 'pending' ? `<button class="btn btn-success btn-sm" style="margin-top:10px;" onclick="approveDriver('${driver.id}')">Setujui</button>` : ''}
                `;
                driverListEl.appendChild(card);
            });
        }

        const orderListEl = document.getElementById('admin-order-list');
        orderListEl.innerHTML = '';
        if (localState.orders.length === 0) {
            orderListEl.innerHTML = '<div class="loading">Belum ada order masuk.</div>';
        } else {
            localState.orders.forEach(order => {
                const card = document.createElement('div');
                card.className = 'order-card';
                let content = `
                    <h4>Order #${order.id}</h4>
                    <div>Pelanggan: ${order.customer ? order.customer.full_name : '...'}</div>
                    <div>Status: <span class="status status-${order.status}">${order.status}</span></div>
                `;
                if (order.status === 'searching_driver') {
                    let selectHtml = `<div class="form-group" style="margin-top:10px;">
                        <select id="assign-driver-${order.id}">
                            ${localState.drivers.filter(d => d.status === 'active').map(d => `<option value="${d.id}">${d.full_name}</option>`).join('')}
                        </select>
                    </div>`;
                    content += selectHtml + `<button class="btn btn-secondary btn-sm" onclick="assignOrder(${order.id})">Tugaskan</button>`;
                } else if(order.driver) {
                    content += `<div>Driver: ${order.driver.full_name}</div>`;
                }
                card.innerHTML = content;
                orderListEl.appendChild(card);
            });
        }
    }
    
    function renderDriverSelector() {
        const driverSelector = document.getElementById('driver-selector');
        driverSelector.innerHTML = localState.drivers.map(d => `<option value="${d.id}">${d.full_name}</option>`).join('');
    }

    function renderDriverPanel(driverId) {
        const driver = localState.drivers.find(d => d.id === driverId);
        if (!driver) return;

        document.getElementById('driver-profile-view').innerHTML = `
            <div class="driver-card">
                <h4>${driver.full_name}</h4>
                <div>Status Akun: <span class="status status-${driver.status}">${driver.status}</span></div>
                <div style="color: var(--success-color);">Saldo: Rp ${driver.balance.toLocaleString('id-ID')}</div>
            </div>`;
        
        const taskListEl = document.getElementById('driver-task-list');
        taskListEl.innerHTML = '';
        const tasks = localState.orders.filter(o => o.driver_id === driverId && o.status !== 'completed' && o.status !== 'cancelled');
        
        if (tasks.length === 0) {
            taskListEl.innerHTML = '<div class="loading">Tidak ada tugas saat ini.</div>';
        } else {
            tasks.forEach(order => {
                const card = document.createElement('div');
                card.className = 'order-card';
                let actionBtn = '';
                if(order.status === 'assigned') actionBtn = `<button class="btn btn-primary btn-sm" onclick="updateOrderStatus(${order.id}, 'pickup')">Jemput Barang</button>`;
                if(order.status === 'pickup') actionBtn = `<button class="btn btn-secondary btn-sm" onclick="updateOrderStatus(${order.id}, 'delivering')">Mulai Antar</button>`;
                if(order.status === 'delivering') actionBtn = `<button class="btn btn-success btn-sm" onclick="updateOrderStatus(${order.id}, 'completed')">Selesaikan Order</button>`;

                card.innerHTML = `
                    <h4>Tugas Order #${order.id}</h4>
                    <div>Pelanggan: ${order.customer.full_name}</div>
                    <div>Status: <span class="status status-${order.status}">${order.status}</span></div>
                    <div style="margin-top:10px;">${actionBtn}</div>
                `;
                taskListEl.appendChild(card);
            });
        }
    }

    /**
     * Fungsi utama untuk mendengarkan perubahan di database secara REALTIME
     */
    function listenToChanges() {
        supabase.channel('public-db-changes')
          .on('postgres_changes', { event: '*', schema: 'public' }, async (payload) => {
            console.log('Perubahan terdeteksi:', payload);
            // Jika ada perubahan, ambil ulang semua data dan render ulang
            // Ini cara sederhana, bisa dioptimalkan untuk hanya update data yg berubah
            await Promise.all([fetchDrivers(), fetchOrders()]);
            renderAdminPanel();
            renderDriverPanel(document.getElementById('driver-selector').value);
          })
          .subscribe();
    }


    // ===================================================================================
    // BAGIAN 4: LOGIKA BISNIS & AKSI PENGGUNA
    // ===================================================================================

    async function approveDriver(driverId) {
        const { error } = await supabase.from('profiles').update({ status: 'active' }).eq('id', driverId);
        if (error) alert('Gagal menyetujui driver: ' + error.message);
    }

    async function assignOrder(orderId) {
        const driverId = document.getElementById(`assign-driver-${orderId}`).value;
        if(!driverId) {
            alert('Tidak ada driver aktif yang bisa ditugaskan.');
            return;
        }
        const { error } = await supabase.from('orders').update({ driver_id: driverId, status: 'assigned' }).eq('id', orderId);
        if (error) alert('Gagal menugaskan order: ' + error.message);
    }

    async function updateOrderStatus(orderId, newStatus) {
        const { error } = await supabase.from('orders').update({ status: newStatus }).eq('id', orderId);
        if (error) {
            alert('Gagal update status: ' + error.message);
            return;
        }

        // Jika order selesai, lakukan transaksi penambahan saldo driver
        if (newStatus === 'completed') {
            const order = localState.orders.find(o => o.id === orderId);
            const driverEarning = order.price * 0.8; // Komisi 80% untuk driver
            
            // Di aplikasi nyata, ini HARUS dilakukan di Supabase Edge Function untuk keamanan
            const { data: driver, error: fetchError } = await supabase.from('profiles').select('balance').eq('id', order.driver_id).single();
            if(fetchError) {
                alert("Error mengambil data saldo driver."); return;
            }
            const newBalance = driver.balance + driverEarning;
            const { error: updateError } = await supabase.from('profiles').update({ balance: newBalance }).eq('id', order.driver_id);
            if (updateError) alert('PENTING: Order selesai tapi gagal update saldo driver. Hubungi admin.');
            else alert(`Order Selesai! Saldo driver telah ditambahkan sebesar Rp ${driverEarning.toLocaleString('id-ID')}`);
        }
    }
    
    async function createOrder() {
        if (!calculatedRoute) {
            alert('Harap hitung biaya terlebih dahulu.'); return;
        }
        
        document.getElementById('order-btn').disabled = true;
        document.getElementById('order-btn').innerText = 'Memproses...';

        const { error } = await supabase.from('orders').insert({
            customer_id: localState.SIMULATED_CUSTOMER_ID,
            pickup_address: calculatedRoute.pickup,
            dropoff_address: calculatedRoute.dropoff,
            pickup_coords: { "type": "Point", "coordinates": calculatedRoute.coords.pickup },
            dropoff_coords: { "type": "Point", "coordinates": calculatedRoute.coords.dropoff },
            price: calculatedRoute.price,
            payment_method: 'SALDO' // Hardcoded untuk simulasi
        });
        
        if (error) {
            alert('Gagal membuat order: ' + error.message);
        } else {
            alert('Order berhasil dibuat! Admin akan segera menugaskan driver.');
            document.getElementById('pickup').value = '';
            document.getElementById('dropoff').value = '';
            document.getElementById('price-display').style.display = 'none';
        }
        document.getElementById('order-btn').disabled = false;
        document.getElementById('order-btn').innerText = 'Order Sekarang';
    }


    // ===================================================================================
    // BAGIAN 5: FUNGSI PETA & OPENROUTESERVICE
    // ===================================================================================

    async function calculateRoute() {
        const pickupQuery = document.getElementById('pickup').value;
        const dropoffQuery = document.getElementById('dropoff').value;

        if (!pickupQuery || !dropoffQuery) {
            alert('Lokasi jemput dan antar harus diisi.'); return;
        }
        if (ORS_API_KEY.includes('API_KEY')) {
            alert('API Key OpenRouteService belum diatur.'); return;
        }
        
        const btn = document.getElementById('calculate-btn');
        btn.disabled = true;
        btn.innerText = 'Menghitung...';

        try {
            // Geocoding untuk mendapatkan koordinat
            const [pickupCoords, dropoffCoords] = await Promise.all([
                geocodeAddress(pickupQuery),
                geocodeAddress(dropoffQuery)
            ]);

            if (!pickupCoords || !dropoffCoords) {
                alert('Satu atau kedua alamat tidak dapat ditemukan.');
                return;
            }
            
            // Dapatkan rute dan jarak
            const url = 'https://api.openrouteservice.org/v2/directions/driving-car/geojson';
            const body = JSON.stringify({ "coordinates": [pickupCoords, dropoffCoords] });
            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Accept': 'application/json, application/geo+json',
                    'Content-Type': 'application/json',
                    'Authorization': ORS_API_KEY
                },
                body: body
            });
            const data = await response.json();
            const routeSummary = data.features[0].properties.summary;
            const distanceInKm = (routeSummary.distance / 1000);
            
            // Hitung harga
            let price = distanceInKm * 2500; // Rp 2.500/km
            if (price < 15000) price = 15000; // Harga minimum
            price = Math.ceil(price / 1000) * 1000; // Pembulatan ke ribuan atas

            // Tampilkan hasil
            document.getElementById('distance').innerText = distanceInKm.toFixed(1) + ' km';
            document.getElementById('price').innerText = 'Rp ' + price.toLocaleString('id-ID');
            document.getElementById('price-display').style.display = 'block';
            document.getElementById('order-btn').disabled = false;
            
            // Simpan data rute
            calculatedRoute = {
                pickup: pickupQuery,
                dropoff: dropoffQuery,
                coords: { pickup: pickupCoords, dropoff: dropoffCoords },
                price: price
            };

        } catch (error) {
            console.error('Error calculating route:', error);
            alert('Terjadi kesalahan saat menghitung rute.');
        } finally {
            btn.disabled = false;
            btn.innerText = 'Hitung Biaya';
        }
    }
    
    async function geocodeAddress(query) {
        const url = `https://api.openrouteservice.org/geocode/search?api_key=${ORS_API_KEY}&text=${encodeURIComponent(query)}&boundary.country=ID&size=1`;
        try {
            const response = await fetch(url);
            const data = await response.json();
            if (data.features && data.features.length > 0) {
                return data.features[0].geometry.coordinates; // [lng, lat]
            }
            return null;
        } catch (error) {
            console.error('Geocoding error:', error);
            return null;
        }
    }

    // ===================================================================================
    // BAGIAN 6: INISIALISASI
    // ===================================================================================
    window.onload = () => {
        map = L.map('map').setView(JABODETABEK_CENTER, 10);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        document.getElementById('calculate-btn').addEventListener('click', calculateRoute);
        document.getElementById('order-btn').addEventListener('click', createOrder);

        initializeApp();
    };

    </script>
</body>
</html>
